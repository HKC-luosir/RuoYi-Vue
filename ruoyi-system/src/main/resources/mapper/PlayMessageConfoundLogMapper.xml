<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.PlayMessageConfoundLogMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.system.domain.PlayMessageConfoundLog">
            <id property="id" column="id" jdbcType="INTEGER"/>
            <result property="messageConfoundId" column="message_confound_id" jdbcType="INTEGER"/>
            <result property="state" column="state" jdbcType="INTEGER"/>
            <result property="executeNum" column="execute_num" jdbcType="INTEGER"/>
            <result property="optSerialNo" column="opt_serial_no" jdbcType="VARCHAR"/>
            <result property="resultContent" column="result_content" jdbcType="VARCHAR"/>
            <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
            <result property="modifyTime" column="modify_time" jdbcType="TIMESTAMP"/>
            <result property="failMessage" column="fail_message" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,message_confound_id,`state`,
        execute_num,opt_serial_no,result_content,
        create_time,modify_time,fail_message
    </sql>

    <select id="selectConfoundList" resultType="com.ruoyi.system.domain.PlayMessageConfoundLog">
        select pl.* from t_play_message_confound pc inner join t_play_message_confound_log pl on
        pc.id = pl.message_confound_id where pc.uuid = #{uuid} and pc.state = 1 and pl.state = 1
    </select>

    <select id="selectRetryingList" resultType="com.ruoyi.system.domain.PlayMessageConfoundLog">
        SELECT
            id,
            message_confound_id,
            `state`,
            execute_num,
            opt_serial_no,
            result_content,
            create_time,
            modify_time
        FROM
            t_play_message_confound_log
        WHERE
            1 = 1
          AND create_time > ADDDATE( NOW( ),- 1 )
          AND state IN ( 0, 2, 3 )
          AND execute_num &lt;= 3
    </select>

    <select id="page" resultType="com.ruoyi.system.domain.vo.QueryConfoundLogVO">
        SELECT
            tpmcl.id,
            tpmcl.create_time,
            tpmc.moment_type_id,
            tpmc.confound_content,
            tpmcl.result_content,
            tpmcl.state,
            tpmcl.execute_num,
            tpmcl.opt_serial_no,
            tpmcl.fail_message
        FROM
            t_play_message_confound tpmc
            INNER JOIN t_play_message_confound_log tpmcl ON tpmc.id = tpmcl.message_confound_id
        WHERE
            1 = 1
            AND tpmc.play_id = #{dto.playId}
        <if test="dto.startTime != null and dto.startTime != ''">
            and tpmcl.create_time >= #{dto.startTime}
        </if>
        <if test="dto.endTime != null and dto.endTime != ''">
            and tpmcl.create_time &lt;= #{dto.endTime}
        </if>
        <if test="dto.state != null">
            and tpmcl.state = #{dto.state}
        </if>
        <if test="dto.momentTypeId != null">
            and tpmc.moment_type_id = #{dto.momentTypeId}
        </if>
        <if test="dto.confoundContent != null and dto.confoundContent != ''">
            and tpmc.confound_content like concat('%',#{dto.confoundContent},'%')
        </if>
        order by tpmcl.id desc
    </select>
</mapper>
