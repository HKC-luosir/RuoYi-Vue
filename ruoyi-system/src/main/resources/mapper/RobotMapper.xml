<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.RobotMapper">
    <select id="selectRobotPageList" resultType="com.ruoyi.system.domain.vo.robot.SelectRobotListVO">
        select tri.*,
               concat(tri.first_name,' ',tri.last_name) as name,
               trs.one_day_join_group_count as groupToDayNum,
               trs.total_join_group_count as groupTotalNum,
               trs.is_lock as occupyType
        from t_robot_info tri left join t_robot_statistics trs on tri.robot_serial_no = trs.robot_serial_no
        where tri.delete_status = 0
          and tri.recycle_status = 0
        <if test="dto.startTime != null and dto.startTime != ''">
            and
            <if test="dto.timeType == 1">
                tri.create_time
            </if>
            <if test="dto.timeType == 2">
                tri.seal_time
            </if>
            <if test="dto.timeType == 3">
                tri.bidirectional_time
            </if>
             >= #{dto.startTime}
        </if>
        <if test="dto.endTime != null and dto.endTime != ''">
            and
            <if test="dto.timeType == 1">
                tri.create_time
            </if>
            <if test="dto.timeType == 2">
                tri.seal_time
            </if>
            <if test="dto.timeType == 3">
                tri.bidirectional_time
            </if>
            &lt; #{dto.endTime}
        </if>
        <if test="dto.type != null">
            and tri.type = #{dto.type}
        </if>
        <if test="dto.tgAppVersion != null and dto.tgAppVersion != ''">
            and tri.tg_app_version = #{dto.tgAppVersion}
        </if>
        <if test="dto.heartbeatStatus != null">
            and tri.heartbeat_status = #{dto.heartbeatStatus}
        </if>
        <if test="dto.sealStatus != null">
            and tri.seal_status = #{dto.sealStatus}
        </if>
        <if test="dto.bidirectionalType != null">
            and tri.bidirectional_type = #{dto.bidirectionalType}
        </if>
        <if test="dto.country != null and dto.country != ''">
            and tri.country like  concat('%',#{dto.country},'%')
        </if>
        <if test="dto.occupyType != null">
            and trs.is_lock = #{dto.occupyType}
        </if>
        <if test="dto.enableType != null">
            and tri.enable_type = #{dto.enableType}
        </if>
        <if test="dto.groupOwner != null">
            and tri.group_owner = #{dto.groupOwner}
        </if>
        <if test="dto.name != null and dto.name != ''">
            and concat(tri.first_name,' ',tri.last_name) like concat('%',#{dto.name},'%')
        </if>
        <if test="dto.phone != null and dto.phone != ''">
            and tri.phone like concat('%',#{dto.phone},'%')
        </if>
        <if test="dto.userName != null and dto.userName != ''">
            and tri.user_name like concat('%',#{dto.userName},'%')
        </if>
        <if test="dto.protocolType != null">
            and tri.protocol_type = #{dto.protocolType}
        </if>
        <if test="dto.isHasUserName != null">
            <if test="dto.isHasUserName == 0">
                and (tri.user_name is null or tri.user_name = '')
            </if>
            <if test="dto.isHasUserName == 1">
                and (tri.user_name is not null and tri.user_name != '')
            </if>
        </if>
        <if test="dto.robotSerialNos != null and dto.robotSerialNos.size > 0">
            and tri.robot_serial_no in
        <foreach collection="dto.robotSerialNos" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        </if>
        <if test="dto.proxyType != null and dto.proxyType != '' and dto.proxyType != '未知'">
            and tri.proxy_type = #{dto.proxyType}
        </if>
        <if test="dto.proxyType != null and dto.proxyType != '' and dto.proxyType == '未知'">
            and (tri.proxy_type is null or tri.proxy_type = '')
        </if>

    </select>

    <select id="getRobotStatisticsVO" resultType="com.ruoyi.system.domain.vo.play.RobotStatisticsVO">
        SELECT
            count( DISTINCT tprgr.robot_id ) AS robotTotalNum,
            SUM( IF ( tri.seal_status = 30, 1, 0 ) ) AS robotClosureNum,
            SUM( IF ( tri.bidirectional_type = 1, 1, 0 ) ) AS bidirectionalRobotNum
        FROM
            t_play_group_info tpgi
                LEFT JOIN t_play_robot_group_relation tprgr ON tpgi.tg_group_id = tprgr.group_id
                LEFT JOIN t_robot_info tri ON tprgr.robot_id = tri.robot_serial_no
        WHERE
            1 = 1
          AND tpgi.play_id = #{playId}
          AND tpgi.into_status = 2
    </select>

</mapper>
