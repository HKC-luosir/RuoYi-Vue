<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.data.price.mapper.UltimateOfficeBasePriceMapper">

    <resultMap type="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
               id="OfficeBasePriceUltimateResult">
        <result property="id" column="id"/>
        <result property="yearMonth" column="yearMonth"/>
        <result property="buildingId" column="BuildingID_P"/>
        <result property="communityId" column="ProjectID_P"/>
        <result property="mainPrice" column="MainPrice"/>
        <result property="mainPriceRent" column="MainPriceRent"/>
        <result property="mainPricePst" column="MainPricePst"/>
        <result property="mainPriceRentPst" column="MainPriceRentPst"/>
        <result property="mainPriceType" column="MainPriceType"/>
        <result property="mainPriceRentType" column="MainPriceRentType"/>
        <result property="updateDate" column="ModifyDate"/>
        <result property="status" column="Status"/>
        <result property="isStandardBuilding" column="BuildingStd"/>
        <result property="adjustPriceComment" column="AdjEvd"/>
        <result property="areaCoefficient" column="AreaCoff"/>
        <result property="yearCoefficient" column="YearCoff"/>
        <result property="buildingCoefficient" column="BuildingCoff"/>
        <result property="communityName" column="ProjectName"/>
        <result property="communityAddress" column="ProjectAddr"/>
        <result property="buildingAddress" column="BuildingAddr"/>
        <result property="countyName" column="County"/>
        <result property="loopName" column="Loop"/>
        <result property="blockName" column="Block"/>
        <result property="streetName" column="Street"/>
        <result property="year" column="year"/>
        <result property="avgArea" column="AvgArea"/>
        <result property="totalFloorSum" column="TotalFloorSum"/>
        <result property="upperFloorSum" column="UpperFloorSum"/>
        <result property="officeClass" column="OfficeClass"/>
        <result property="officeLevel" column="Grade"/>
        <result property="mainPrice_1" column="mainPrice_1"/>
        <result property="mainPriceRent_1" column="mainPriceRent_1"/>
    </resultMap>

    <sql id="getById">
        SELECT a.ID
                ,a.BuildingID_P
                ,a.ProjectID_P
                ,a.MainPrice
                ,a.MainPriceRent
                ,a.MainPricePst
                ,a.MainPriceRentPst
                ,a.MainPriceType
                ,a.MainPriceRentType
                ,a.ModifyDate
                ,a.Status
                ,a.BuildingStd
                ,a.AdjEvd
                ,b.AreaCoff
                ,b.YearCoff
                ,b.BuildingCoff
                ,b.ProjectName
                ,b.ProjectAddr
                ,b.BuildingAddr
                ,b.County
                ,b.Loop
                ,b.Block
                ,b.Street
                ,b.Year
                ,b.AvgArea
                ,b.TotalFloorSum
                ,b.UpperFloorSum
                ,b.OfficeClass
                ,b.Grade
                ,c.MainPrice AS mainPrice_1
                ,c.MainPriceRent as mainPriceRent_1
                , ${yearMonth} as yearMonth
        FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
        left join DIM_OFFICE_PROJECT_BUILDING_201909 b on a.BuildingID_P=b.BuildingID_P
        left join ODS_OFFICE_BUILDING_PRICE_INFO_${lastYearMonth} c on a.BuildingID_P = c.BuildingID_P
        WHERE b.EffDate <![CDATA[ <= ]]> getdate() AND b.ExpirDate <![CDATA[ > ]]> getdate() AND c.Status=1
    </sql>

    <select id="getCount" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice" resultType="int">
        select count(1) FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
        left join DIM_OFFICE_PROJECT_BUILDING_201909 b on a.BuildingID_P=b.BuildingID_P
        left join ODS_OFFICE_BUILDING_PRICE_INFO_${lastYearMonth} c on a.BuildingID_P = c.BuildingID_P
        WHERE b.EffDate <![CDATA[ <= ]]> getdate() AND b.ExpirDate <![CDATA[ > ]]> getdate() AND c.Status=1
        <if test="communityId != null">
            AND a.PROJECTID_P = #{communityId}
        </if>
        <if test="buildingId != null">
            AND a.BUILDINGID_P = #{buildingId}
        </if>
        <if test="status != null">
            AND a.STATUS = #{status}
        </if>
    </select>

    <select id="getList" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
            resultMap="OfficeBasePriceUltimateResult">
        <include refid="getById"/>
        <if test="communityId != null">
            AND a.PROJECTID_P = #{communityId}
        </if>
        <if test="buildingId != null">
            AND a.BUILDINGID_P = #{buildingId}
        </if>
        <if test="status != null">
            AND a.STATUS = #{status}
        </if>
        order by a.ModifyDate DESC,a.BUILDINGID_P ASC OFFSET #{pageIndex} rows fetch next #{pageSize} rows only;
    </select>

    <select id="getById" resultMap="OfficeBasePriceUltimateResult">
        <include refid="getById"/>
        <if test="id != null">
            AND a.id=#{id}
        </if>
    </select>

    <!-- 更新基价 -->
    <update id="updateBasePrice" parameterType="com.ruoyi.project.data.price.domain.OfficeBasePriceModifyModel">
          update ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} set Status=0 where id=#{id};
    </update>
    <insert id="batchInsertArtificialOfficeBase" >
        insert into
        dbo.DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth}(ID,BuildingID,ProjectID,County,"Loop",Block,ProjectAddr,ProjectName,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,ModifyDate)
        values
      <foreach collection="list" item="item" separator="," >
          (#{item.id},#{item.buildingId},#{item.communityId},#{item.countyName},#{item.loopName},#{item.blockName},#{item.communityAddress},#{item.communityName},#{item.year},#{item.avgArea},#{item.totalFloorSum},#{item.upperFloorSum},#{item.officeClass},#{item.officeLevel},#{item.mainPrice_1},#{item.mainPriceRent_1},#{item.mainPrice},#{item.mainPriceRent},getdate())
      </foreach>
    </insert>
    <!-- 更新基价 -->
    <insert id="updateBasePriceCopyNew" parameterType="com.ruoyi.project.data.price.domain.OfficeBasePriceModifyModel">
        insert into ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}(BuildingID
              ,UnifiedID
              ,ProjectID
              ,BuildingID_P
              ,ProjectID_P
              ,MainPrice
              ,MainPriceRent
              ,MainPricePst
              ,MainPriceRentPst
              ,MainPriceType
              ,MainPriceRentType
              ,ModifyDate
              ,Status
              ,BuildingStd
              ,AdjEvd)
          select BuildingID
              ,UnifiedID
              ,ProjectID
              ,BuildingID_P
              ,ProjectID_P
              ,#{mainPrice}
              ,#{mainPriceRent}
              ,#{mainPricePst}
              ,#{mainPriceRentPst}
              ,MainPriceType
              ,MainPriceRentType
              ,getdate()
              ,1
              ,BuildingStd
              ,#{comment}
            from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} where id=#{id};
    </insert>

    <!-- 获取表名   -->
    <select id="getYearMonthList" resultType="com.ruoyi.project.common.VueSelectModel">
        SELECT right(name,6) as value, right(name,6) as label
        FROM sys.tables
        where name like 'ODS_OFFICE_BUILDING_PRICE_INFO_%' and name not like '%_bak'
        order by cast(right(name,6) as int) desc
    </select>
    <!--    -->
    <select id="getByBuildingId" resultType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        select ID
              ,BuildingID_P as buildingId
              ,ProjectID_P as communityId
              ,MainPrice as mainPrice
              ,MainPriceRent as mainPriceRent
              ,MainPricePst as mainPricePst
              ,MainPriceRentPst as mainPriceRentPst
              ,MainPriceType as mainPriceType
              ,MainPriceRentType as mainPriceRentType
              ,Status as status
              ,BuildingStd as isStandardBuilding
              ,AdjEvd as adjustPriceComment
              ,${yearMonth} as yearMonth
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        where BuildingID_P=#{buildingId} AND status= 1
    </select>
    <!-- 查询价格 -->
    <select id="getByRouteId" resultType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        SELECT ID
              ,BuildingID_P as buildingId
              ,ProjectID_P as communityId
              ,MainPrice as mainPrice
              ,MainPriceRent as mainPriceRent
              ,MainPricePst as mainPricePst
              ,MainPriceRentPst as mainPriceRentPst
              ,MainPriceType as mainPriceType
              ,MainPriceRentType as mainPriceRentType
              ,Status as status
              ,BuildingStd as isStandardBuilding
              ,AdjEvd as adjustPriceComment
              ,${yearMonth} as yearMonth
        FROM dbo.ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        WHERE ID=#{id}
    </select>
    <!-- 插入人工修正办公基价  -->
    <insert id="insertArtificialOfficeBasePrice"
            parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        insert into
        dbo.DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth}(ID,BuildingID,ProjectID,County,"Loop",Block,ProjectAddr,ProjectName,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,ModifyDate) values(#{id},#{buildingId},#{communityId},#{countyName},#{loopName},#{blockName},#{communityAddress},#{communityName},#{year},#{avgArea},#{totalFloorSum},#{upperFloorSum},#{officeClass},#{officeLevel},#{mainPrice_1},#{mainPriceRent_1},#{mainPrice},#{mainPriceRent},getdate())
    </insert>
</mapper>