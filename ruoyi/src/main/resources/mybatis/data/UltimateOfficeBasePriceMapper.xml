<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.data.price.mapper.UltimateOfficeBasePriceMapper">

    <resultMap type="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
               id="OfficeBasePriceUltimateResult">
        <result property="id" column="id"/>
        <result property="yearMonth" column="yearMonth"/>
        <result property="buildingId" column="BuildingID_P"/>
        <result property="communityId" column="ProjectID_P"/>
        <result property="mainPrice" column="MainPrice"/>
        <result property="mainPriceRent" column="MainPriceRent"/>
        <result property="mainPricePst" column="MainPricePst"/>
        <result property="mainPriceRentPst" column="MainPriceRentPst"/>
        <result property="mainPriceType" column="MainPriceType"/>
        <result property="mainPriceRentType" column="MainPriceRentType"/>
        <result property="updateDate" column="ModifyDate"/>
        <result property="status" column="Status"/>
        <result property="isStandardBuilding" column="BuildingStd"/>
        <result property="adjustPriceComment" column="AdjEvd"/>
        <result property="areaCoefficient" column="AreaCoff"/>
        <result property="yearCoefficient" column="YearCoff"/>
        <result property="buildingCoefficient" column="BuildingCoff"/>

        <result property="communityName" column="ProjectName"/>
        <result property="communityAddress" column="ProjectAddr"/>
        <result property="buildingAddress" column="BuildingAddr"/>
        <result property="countyName" column="County"/>
        <result property="loopName" column="Loop"/>
        <result property="blockName" column="Block"/>
        <result property="streetName" column="Street"/>
        <result property="year" column="year"/>
        <result property="avgArea" column="AvgArea"/>
        <result property="totalFloorSum" column="TotalFloorSum"/>
        <result property="upperFloorSum" column="UpperFloorSum"/>
        <result property="officeClass" column="OfficeClass"/>
        <result property="officeLevel" column="Grade"/>
        <result property="mainPrice_1" column="mainPrice_1"/>
        <result property="mainPriceRent_1" column="mainPriceRent_1"/>
    </resultMap>

    <sql id="selectOfficeBasePriceUltimateVo">
        SELECT a.ID
                ,a.BuildingID_P
                ,a.ProjectID_P
                ,a.MainPrice
                ,a.MainPriceRent
                ,a.MainPricePst
                ,a.MainPriceRentPst
                ,a.MainPriceType
                ,a.MainPriceRentType
                ,a.ModifyDate
                ,a.Status
                ,a.BuildingStd
                ,a.AdjEvd
                ,b.AreaCoff
                ,b.YearCoff
                ,b.BuildingCoff
                ,b.ProjectName
                ,b.ProjectAddr
                ,b.BuildingAddr
                ,b.County
                ,b.Loop
                ,b.Block
                ,b.Street
                ,b.Year
                ,b.AvgArea
                ,b.TotalFloorSum
                ,b.UpperFloorSum
                ,b.OfficeClass
                ,b.Grade
                ,c.MainPrice AS mainPrice_1
                ,c.MainPriceRent as mainPriceRent_1
                , ${yearMonth} as yearMonth
        FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
        left join DIM_OFFICE_PROJECT_BUILDING_201909 b on a.BuildingID_P=b.BuildingID_P
        left join ODS_OFFICE_BUILDING_PRICE_INFO_${lastYearMonth} c on a.BuildingID_P = c.BuildingID_P
        WHERE b.EffDate <![CDATA[ <= ]]> getdate() AND b.ExpirDate <![CDATA[ > ]]> getdate() AND A.STATUS=1 AND
        c.Status=1
    </sql>

    <select id="getCount" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice" resultType="int">
        select count(1) FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
        left join DIM_OFFICE_PROJECT_BUILDING_201909 b on a.BuildingID_P=b.BuildingID_P
        left join ODS_OFFICE_BUILDING_PRICE_INFO_${lastYearMonth} c on a.BuildingID_P = c.BuildingID_P
        WHERE b.EffDate <![CDATA[ <= ]]> getdate() AND b.ExpirDate <![CDATA[ > ]]> getdate() AND A.STATUS=1 AND
        c.Status=1
        <where>
            <if test="communityId != null">
               AND a.PROJECTID_P = #{communityId}
            </if>
            <if test="buildingId != null">
                AND a.BUILDINGID_P = #{buildingId}
            </if>
            <if test="status != null">
                AND a.STATUS = #{status}
            </if>
        </where>
    </select>

    <select id="getList" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
            resultMap="OfficeBasePriceUltimateResult">
        <include refid="selectOfficeBasePriceUltimateVo"/>
        <where>
            <if test="communityId != null">
               AND a.PROJECTID_P = #{communityId}
            </if>
            <if test="buildingId != null">
                AND a.BUILDINGID_P = #{buildingId}
            </if>
            <if test="status != null">
                AND a.STATUS = #{status}
            </if>
        </where>
        order by a.BUILDINGID_P ASC,a.ID DESC OFFSET #{pageIndex} rows fetch next #{pageSize} rows only;
    </select>

    <select id="getById" parameterType="String" resultMap="OfficeBasePriceUltimateResult">
        <include refid="selectOfficeBasePriceUltimateVo"/>
        where id = #{id}
    </select>

    <insert id="copyCreate">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into
        dbo.ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}(BuildingID,UnifiedID,ProjectID,BuildingID_P,ProjectID_P,MainPrice,MainPriceRent,MainPricePst,MainPriceRentPst,MainPriceType,MainPriceRentType,ModifyDate,Status,BuildingStd,AdjEvd)
        select BuildingID,UnifiedID,ProjectID,BuildingID_P,ProjectID_P,MainPrice,MainPriceRent,MainPricePst,MainPriceRentPst,MainPriceType,MainPriceRentType,ModifyDate,0,BuildingStd,AdjEvd
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        where id=#{id}
    </insert>
    <!-- 更新 -->
    <update id="update">
        update a set ModifyDate=getdate(), mainPrice=#{mainPrice}, mainPriceRent=#{mainPriceRent},
        mainPricePst = #{mainPrice} * 1.0 / b.mainPrice, mainPriceRentPst = #{mainPriceRentPst} * 1.0 / b.mainPriceRentPst
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a join ODS_OFFICE_BUILDING_PRICE_INFO_${lastYearMonth} b on
        a.BuildingID_p=b.BuildingID_P
        where a.Status=1 and b.Status=1 and a.id=#{id}
    </update>

    <!-- 获取表名   -->
    <select id="getYearMonthList" resultType="com.ruoyi.project.common.VueSelectModel">
        SELECT right(name,6) as value, right(name,6) as label
        FROM sys.tables
        where name like 'ODS_OFFICE_BUILDING_PRICE_INFO_%'
        order by cast(right(name,6) as int) desc
    </select>
    <!--    -->
    <select id="getByBuildingId" resultType="com.ruoyi.project.data.price.controller.UltimateOfficeBasePriceController">
        select id,MainPrice,MainPriceRent
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        where BuildingID_P=#{buildingI}
    </select>
</mapper>