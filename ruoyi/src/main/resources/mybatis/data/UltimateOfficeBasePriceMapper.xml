<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.data.price.mapper.UltimateOfficeBasePriceMapper">

    <resultMap type="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
               id="OfficeBasePriceUltimateResult">
        <result property="id" column="id"/>
        <result property="yearMonth" column="yearMonth"/>
        <result property="buildingId" column="BuildingID_P"/>
        <result property="communityId" column="ProjectID_P"/>
        <result property="mainPrice" column="MainPrice"/>
        <result property="mainPriceRent" column="MainPriceRent"/>
        <result property="mainPricePst" column="MainPricePst"/>
        <result property="mainPriceRentPst" column="MainPriceRentPst"/>
        <result property="mainPriceType" column="MainPriceType"/>
        <result property="mainPriceRentType" column="MainPriceRentType"/>
        <result property="updateDate" column="ModifyDate"/>
        <result property="status" column="Status"/>
        <result property="standardBuilding" column="BuildingStd"/>
        <result property="adjustPriceComment" column="AdjEvd"/>
        <result property="areaCoefficient" column="AreaCoff"/>
        <result property="yearCoefficient" column="YearCoff"/>
        <result property="buildingCoefficient" column="BuildingCoff"/>
        <result property="communityName" column="ProjectName"/>
        <result property="communityAddress" column="ProjectAddr"/>
        <result property="buildingAddress" column="BuildingAddr"/>
        <result property="countyName" column="County"/>
        <result property="loopName" column="Loop"/>
        <result property="blockName" column="Block"/>
        <result property="streetName" column="Street"/>
        <result property="year" column="year"/>
        <result property="avgArea" column="AvgArea"/>
        <result property="totalFloorSum" column="TotalFloorSum"/>
        <result property="upperFloorSum" column="UpperFloorSum"/>
        <result property="officeClass" column="OfficeClass"/>
        <result property="officeLevel" column="Grade"/>
        <result property="mainPrice_1" column="mainPrice_1"/>
        <result property="mainPriceRent_1" column="mainPriceRent_1"/>
    </resultMap>

    <sql id="getById">
        SELECT a.ID
                ,a.BuildingID_P
                ,a.ProjectID_P
                ,a.MainPrice
                ,a.MainPriceRent
                ,a.MainPricePst
                ,a.MainPriceRentPst
                ,a.MainPriceType
                ,a.MainPriceRentType
                ,a.ModifyDate
                ,a.Status
                ,a.BuildingStd
                ,a.AdjEvd
                ,a.AreaCoff
                ,a.YearCoff
                ,a.BuildingCoff
                ,a.ProjectName
                ,a.ProjectAddr
                ,a.BuildingAddr
                ,a.County
                ,a.Loop
                ,a.Block
                ,a.Street
                ,a.Year
                ,a.AvgArea
                ,a.TotalFloorSum
                ,a.UpperFloorSum
                ,a.OfficeClass
                ,a.Grade
                ,a.mainPrice_1
                ,a.mainPriceRent_1
                , ${yearMonth} as yearMonth
        FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
    </sql>

    <select id="getCount" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice" resultType="int">
        select count(1) FROM ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} a
        <where>
            <if test="communityId != null">
                AND a.PROJECTID_P = #{communityId}
            </if>
            <if test="buildingId != null">
                AND a.BUILDINGID_P = #{buildingId}
            </if>
            <if test="status != null">
                AND a.STATUS = #{status}
            </if>
            <if test="standardBuilding != null">
                AND a.BuildingStd = #{standardBuilding}
            </if>
            <if test="nameOrAddress != null">
                AND (
                a.ProjectName like concat('%', #{nameOrAddress} ,'%') or
                a.ProjectAddr like concat('%', #{nameOrAddress} ,'%') or
                a.BuildingAddr like concat('%', #{nameOrAddress} ,'%')
                )
            </if>
        </where>
    </select>

    <select id="getList" parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice"
            resultMap="OfficeBasePriceUltimateResult">
        <include refid="getById"/>
        <where>
            <if test="communityId != null">
                AND a.PROJECTID_P = #{communityId}
            </if>
            <if test="buildingId != null">
                AND a.BUILDINGID_P = #{buildingId}
            </if>
            <if test="status != null">
                AND a.STATUS = #{status}
            </if>
            <if test="standardBuilding != null">
                AND a.BuildingStd = #{standardBuilding}
            </if>
            <if test="nameOrAddress != null">
                AND (
                a.ProjectName like concat('%', #{nameOrAddress} ,'%') or
                a.ProjectAddr like concat('%', #{nameOrAddress} ,'%') or
                a.BuildingAddr like concat('%', #{nameOrAddress} ,'%')
                )
            </if>
        </where>
        order by a.id desc OFFSET #{pageIndex} rows fetch next #{pageSize} rows only;
    </select>

    <select id="getById" resultMap="OfficeBasePriceUltimateResult">
        <include refid="getById"/>
        <where>
            <if test="id != null">
                AND a.id=#{id}
            </if>
        </where>
    </select>

    <!-- 更新基价 -->
    <update id="updateBasePrice" parameterType="com.ruoyi.project.data.price.domain.OfficeBasePriceModifyModel">
          update ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} set Status=0 where id=#{id};
    </update>
    <insert id="batchInsertArtificialOfficeBase">
        insert into
        dbo.DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth}(ID,BuildingID,ProjectID,County,"Loop",Block,ProjectAddr,ProjectName,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,ModifyDate)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.buildingId},#{item.communityId},#{item.countyName},#{item.loopName},#{item.blockName},#{item.communityAddress},#{item.communityName},#{item.year},#{item.avgArea},#{item.totalFloorSum},#{item.upperFloorSum},#{item.officeClass},#{item.officeLevel},#{item.mainPrice_1},#{item.mainPriceRent_1},#{item.mainPrice},#{item.mainPriceRent},getdate())
        </foreach>
    </insert>
    <!-- 更新基价 -->
    <insert id="updateBasePriceCopyNew" parameterType="com.ruoyi.project.data.price.domain.OfficeBasePriceModifyModel">
        insert into ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}(BuildingID
              ,UnifiedID
              ,ProjectID
              ,BuildingID_P
              ,ProjectID_P
              ,MainPrice
              ,MainPriceRent
              ,MainPricePst
              ,MainPriceRentPst
              ,MainPriceType
              ,MainPriceRentType
              ,ModifyDate
              ,Status
              ,BuildingStd
              ,AdjEvd)
          select BuildingID
              ,UnifiedID
              ,ProjectID
              ,BuildingID_P
              ,ProjectID_P
              ,#{mainPrice}
              ,#{mainPriceRent}
              ,#{mainPricePst}
              ,#{mainPriceRentPst}
              ,MainPriceType
              ,MainPriceRentType
              ,getdate()
              ,1
              ,BuildingStd
              ,#{comment}
            from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} where id=#{id};
    </insert>

    <!-- 获取表名   -->
    <select id="getYearMonthList" resultType="com.ruoyi.project.common.VueSelectModel">
        SELECT right(name,6) as value, right(name,6) as label
        FROM sys.tables
        where name like 'ODS_OFFICE_BUILDING_PRICE_INFO_%' and name not like '%_bak'
        order by cast(right(name,6) as int) desc
    </select>
    <!--    -->
    <select id="getByBuildingId" resultType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        select ID
              ,BuildingID_P as buildingId
              ,ProjectID_P as communityId
              ,MainPrice as mainPrice
              ,MainPriceRent as mainPriceRent
              ,MainPricePst as mainPricePst
              ,MainPriceRentPst as mainPriceRentPst
              ,MainPriceType as mainPriceType
              ,MainPriceRentType as mainPriceRentType
              ,Status as status
              ,BuildingStd as standardBuilding
              ,AdjEvd as adjustPriceComment
              ,${yearMonth} as yearMonth
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        where BuildingID_P=#{buildingId} AND status= 1
    </select>
    <!-- 查询价格 -->
    <select id="getByRouteId" resultType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        SELECT ID
              ,BuildingID_P as buildingId
              ,ProjectID_P as communityId
              ,MainPrice as mainPrice
              ,MainPriceRent as mainPriceRent
              ,MainPricePst as mainPricePst
              ,MainPriceRentPst as mainPriceRentPst
              ,MainPriceType as mainPriceType
              ,MainPriceRentType as mainPriceRentType
              ,Status as status
              ,BuildingStd as standardBuilding
              ,AdjEvd as adjustPriceComment
              ,${yearMonth} as yearMonth
        FROM dbo.ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        WHERE ID=#{id}
    </select>
    <!-- 插入人工修正办公基价  -->
    <insert id="insertArtificialOfficeBasePrice"
            parameterType="com.ruoyi.project.data.price.domain.UltimateOfficeBasePrice">
        insert into
        dbo.DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth}(ID,BuildingID,ProjectID,County,"Loop",Block,ProjectAddr,ProjectName,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,ModifyDate)
        values(#{id},#{buildingId},#{communityId},#{countyName},#{loopName},#{blockName},#{communityAddress},#{communityName},#{year},#{avgArea},#{totalFloorSum},#{upperFloorSum},#{officeClass},#{officeLevel},#{mainPrice_1},#{mainPriceRent_1},#{mainPrice},#{mainPriceRent},getdate())
    </insert>
    <!-- 更新状态 -->
    <update id="updateStatus">
        update ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth} set Status=0 where id=#{id};
    </update>
    <!-- 新增记录   -->
    <update id="insertNewRecord">
        insert into dbo.ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        (
            BuildingID
          , UnifiedID
          , ProjectID
          , BuildingID_P
          , ProjectID_P
          , MainPrice
          , MainPriceRent
          , MainPricePst
          , MainPriceRentPst
          , MainPriceType
          , MainPriceRentType
          , ModifyDate
          , Status
          , BuildingStd
          , AdjEvd
          , MainPrice_1
          , MainPriceRent_1
          , AreaCoff
          , YearCoff
          , BuildingCoff
          , ProjectName
          , ProjectAddr
          , BuildingAddr
          , County
          , Loop
          , Block
          , Street
          , Year
          , AvgArea
          , TotalFloorSum
          , UpperFloorSum
          , OfficeClass
          , Grade
        )
        select BuildingID
          , UnifiedID
          , ProjectID
          , BuildingID_P
          , ProjectID_P
          , #{mainPrice}
          , #{mainPriceRent}
          , #{mainPricePst}
          , #{mainPriceRentPst}
          , #{mainPriceType}
          , #{mainPriceRentType}
          , getdate()
          , 1
          , BuildingStd
          , AdjEvd
          , MainPrice_1
          , MainPriceRent_1
          , AreaCoff
          , YearCoff
          , BuildingCoff
          , ProjectName
          , ProjectAddr
          , BuildingAddr
          , County
          , Loop
          , Block
          , Street
          , Year
          , AvgArea
          , TotalFloorSum
          , UpperFloorSum
          , OfficeClass
          , Grade
        from ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}
        where id=#{id};
    </update>
    <update id="initProcedure">
        IF OBJECT_ID('BatchImportOfArtificialOfficePrice', 'P') IS NOT NULL
	        drop procedure BatchImportOfArtificialOfficePrice;
    </update>
    <!--准备批量导入-->
    <update id="prepareBachImport">
        create procedure dbo.BatchImportOfArtificialOfficePrice @table DWA_PROJECTBASEPRICE_OFFICE_MANU_Table readonly
        as
        begin
            insert into dbo.DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth} (id,BuildingID_P,ProjectID_P,ProjectName,ProjectAddr,BuildingAddr,County,Loop,Block,Street,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,MainPricePst,MainPriceRentPst,MainPriceType,MainPriceRentType,AreaCoff,YearCoff,BuildingCoff,BuildingStd,AdjEvd,ModifyDate)
            select id,BuildingID_P,ProjectID_P,ProjectName,ProjectAddr,BuildingAddr,County,Loop,Block,Street,Year,AvgArea,TotalFloorSum,UpperFloorSum,OfficeClass,Grade,MainPrice_1,MainPriceRent_1,MainPrice,MainPriceRent,MainPricePst,MainPriceRentPst,MainPriceType,MainPriceRentType,AreaCoff,YearCoff,BuildingCoff,BuildingStd,AdjEvd,getdate()
            from @table;
        end;
    </update>
    <update id="dumpTable">
        select * into ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth}_${operateDate}_bak from
        ODS_OFFICE_BUILDING_PRICE_INFO_${yearMonth};
    </update>
    <update id="clearArtificialTable">
        truncate table DWA_PROJECTBASEPRICE_OFFICE_MANU_${yearMonth}
    </update>
</mapper>