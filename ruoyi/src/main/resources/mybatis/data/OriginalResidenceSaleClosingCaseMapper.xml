<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.data.cases.mapper.OriginalResidenceSaleClosingCaseMapper">

<!--    <update id="createRawClosingCaseTable">-->
<!--        <bind name="targetTableName" value="'dbo.二手房成交数据' + yearMonth" />-->
<!--        IF OBJECT_ID(#{targetTableName}, 'U') IS NOT NULL-->
<!--        drop table ${targetTableName};-->

<!--        create table ${targetTableName}-->
<!--        (-->
<!--            case_id uniqueidentifier not null primary key,-->
<!--            区域 varchar (255) NULL,-->
<!--            板块 varchar (255) NULL,-->
<!--            环线 varchar (255) NULL,-->
<!--            小区名称 varchar (255) NULL,-->
<!--            房屋地址 varchar (255) NULL,-->
<!--            面积 float NULL,-->
<!--            房屋类型 varchar (255) NULL,-->
<!--            总价 float NULL,-->
<!--            单价 float NULL,-->
<!--            登记日期 varchar (255) NULL,-->
<!--            签约日期 varchar (255) NULL,-->
<!--            中介公司 varchar (255) NULL,-->
<!--            中介类型 varchar (255) NULL,-->
<!--            卖家类型 float NULL,-->
<!--            买家类型 varchar (5) NULL,-->
<!--            出生年月日 varchar (5) NULL-->
<!--        )-->
<!--    </update>-->

    <!-- 外部数据重复问题   -->
    <update id="createRawTable">
        <bind name="targetTableName" value="'dbo.original_residence_sale_closing_case_' + yearMonth"/>
        IF OBJECT_ID(#{targetTableName}, 'U') IS NOT NULL
            drop table ${targetTableName};

        CREATE TABLE ${targetTableName}
        (
            case_id varchar(32) not null,
            case_county_name nvarchar(20) null,
            case_block_name nvarchar(20) null,
            case_loopline_name nvarchar(20) null,
            case_community_name nvarchar(200) null,
            case_address nvarchar(500) not null,
            case_area decimal(18, 2) not null,
            case_unit_price decimal(18, 2) not null,
            case_total_price decimal(18, 2) not null,
            case_house_type nvarchar(20) null,
            case_signing_date date null,
            case_register_date date null,
            case_current_floor int null,
            case_house_property nvarchar(20) null,
            case_apartment_layout nvarchar(20) null,
            case_compute_unit_price decimal(18, 2) null,
            case_compute_total_price decimal(18, 2) null,
            case_ref_unit_price decimal(18, 2) null,
            case_ref_total_price decimal(18, 2) null,
            case_agency_name nvarchar(200) null,
            case_agency_type nvarchar(50) null,
            case_seller_type nvarchar(20) null,
            case_buyer_type nvarchar(20) null,
            case_birthday date null,
            case_deal_type int not null,
            clean_condo_id nvarchar(20) null,
            clean_building_id nvarchar(20) null,
            clean_community_id nvarchar(20) null,
            clean_condo_address nvarchar(500) null,
            clean_property_type nvarchar(20) not null,
            create_time datetime not null,
            clean_current_floor int null,
            clean_building_address nvarchar(200) null
        );
    </update>

    <update id="createCleanTable">
        <bind name="targetTableName" value="'dbo.ODS_HOUSINGCASE_DEAL_' + yearMonth"/>
        IF OBJECT_ID(#{targetTableName}, 'U') IS NOT NULL
            drop table ${targetTableName};

        CREATE TABLE ${targetTableName}
        (
            id int identity(1,1) not null primary key,
            case_id varchar(32) not null,
            ProjectID bigint NULL,
            BuildingID bigint NULL,
            Area decimal (18, 2) NULL,
            UpperFloorSum nvarchar (32) null,
            UpperFloorNum nvarchar (32) NULL,
            AreaCoff decimal (7, 4) NULL,
            FloorCoff decimal (7, 4) NULL,
            BuildingCoff decimal (7, 4) NULL,
            PriceTotal decimal (18, 2) NOT NULL,
            PriceUnit decimal (18, 2) NOT NULL,
            PriceUnitAdj decimal (18, 2) NOT NULL,
            DateContract date NULL
        );
    </update>
    <insert id="insertRawTable" parameterType="com.ruoyi.project.data.cases.domain.OriginalResidenceSaleClosingCase">
        <bind name="targetTableName" value="'dbo.original_residence_sale_closing_case_' + yearMonth"/>
        insert into ${targetTableName}
        (
            case_id
          , case_county_name
          , case_block_name
          , case_loopline_name
          , case_community_name
          , case_address
          , case_area
          , case_unit_price
          , case_total_price
          , case_house_type
          , case_signing_date
          , case_register_date
          , case_agency_name
          , case_agency_type
          , case_seller_type
          , case_buyer_type
          , case_birthday
          , case_deal_type
          , clean_property_type
          , create_time
        )
        values(
            #{caseId},
            #{caseCountyName},
            #{caseBlockName},
            #{caseLoopName},
            #{caseCommunityName},
            #{caseAddress},
            #{caseArea},
            #{caseUnitPrice},
            #{caseTotalPrice},
            #{caseHouseType},
            #{caseSigningDate,jdbcType=DATE},
            #{caseRegisterDate,jdbcType=DATE},
            #{agencyName},
            #{agencyType},
            #{sellerType},
            #{buyerType},
            #{birthday,jdbcType=DATE},
            2,
            #{cleanPropertyType},
            getdate()
        )
    </insert>
</mapper>